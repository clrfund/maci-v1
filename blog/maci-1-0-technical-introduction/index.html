<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">A Technical Introduction to MACI 1.0 | MACI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://maci.pse.dev/img/maci.jpeg"><meta data-rh="true" name="twitter:image" content="https://maci.pse.dev/img/maci.jpeg"><meta data-rh="true" property="og:url" content="https://maci.pse.dev/blog/maci-1-0-technical-introduction"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="A Technical Introduction to MACI 1.0 | MACI"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-09-22T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/kcharbo3"><meta data-rh="true" property="article:tag" content="zk,maci,release,voting,security"><link data-rh="true" rel="icon" href="/img/maci-logo-2.png"><link data-rh="true" rel="canonical" href="https://maci.pse.dev/blog/maci-1-0-technical-introduction"><link data-rh="true" rel="alternate" href="https://maci.pse.dev/blog/maci-1-0-technical-introduction" hreflang="en"><link data-rh="true" rel="alternate" href="https://maci.pse.dev/blog/maci-1-0-technical-introduction" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="MACI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="MACI Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.08505319.css">
<script src="/assets/js/runtime~main.9314be49.js" defer="defer"></script>
<script src="/assets/js/main.b739aa52.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">MACI</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/typedoc">Typedoc</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/introduction">v1.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/introduction">v1.x</a></li><li><a class="dropdown__link" href="/docs/v0.x/introduction">v0.x</a></li></ul></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/privacy-scaling-explorations/maci" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome to MACI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/maci-v1-1-1-release">Maci v1.1.1 Release</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/maci-1-0-technical-introduction">A Technical Introduction to MACI 1.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/maci-1-0-release">MACI 1.0 Release</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Introduction"><header><h1 class="title_f1Hy" itemprop="headline">A Technical Introduction to MACI 1.0</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-09-22T00:00:00.000Z" itemprop="datePublished">September 22, 2022</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/kcharbo3" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/30647178?v=4" alt="Kyle Charbonnet" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/kcharbo3" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kyle Charbonnet</span></a></div><small class="avatar__subtitle" itemprop="description">Privacy and Scaling Explorations (PSE)</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>MACI, which stands for Minimal Anti-Collusion Infrastructure, is an application that allows users to have an on-chain voting process with greatly increased collusion resistance. A common problem among today’s on-chain voting processes is how easy it is to bribe voters into voting for a particular option. Oftentimes this bribery takes the form of “join our pool (vote our way) and we will give you a cut of the rewards (the bribe)”. Since all transactions on the blockchain are public, without MACI, voters can easily prove to the briber which option they voted for and therefore receive the bribe rewards.</p>
<p>MACI counters this by using zk-SNARKs to essentially hide how each person voted while still revealing the final vote result. User’s cannot prove which option they voted for, and therefore bribers cannot reliably trust that a user voted for their preferred option. For example, a voter can tell a briber that they are voting for option A, but in reality they voted for option B. There is no reliable way to prove which option the voter actually voted for, so the briber does not have the incentive to pay voters to vote their way.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2>
<p>For a general overview, the history and the importance of MACI, see Release Announcement: MACI 1.0 by Wei Jie, one of the creators. He also created a very helpful youtube video on the overview of MACI. To see the origin of the idea of MACI, see Vitalik’s research post on Minimal Anti-Collusion Infrastructure. Lastly, it is recommended to understand the basic idea behind zk-SNARKs, as these are a core component of MACI. The following articles are great resources:</p>
<ul>
<li>Introduction to zk-SNARKs — Consensys</li>
<li>What are zk-SNARKs — Zcash</li>
<li>An approximate introduction to how zk-SNARKs are possible — Vitalik</li>
<li>zkSNARKs in a nutshell — Ethereum.org</li>
</ul>
<p>This article will go over the general workflow of MACI and how it is capable of providing the following tenets (taken word for word from Wei Jie’s article):</p>
<ul>
<li>Collusion Resistance: No one except a trusted coordinator should be certain of the validity of a vote, reducing the effectiveness of bribery</li>
<li>Receipt-freeness: No voter may prove (besides to the coordinator) which way they voted</li>
<li>Privacy: No one except a trusted coordinator should be able to decrypt a vote</li>
<li>Uncensorability: No one (not even the trusted coordinator) should be able to censor a vote</li>
<li>Unforgeability: Only the owner of a user’s private key may cast a vote tied to its corresponding public key</li>
<li>Non-repudiation: No one may modify or delete a vote after it is cast, although a user may cast another vote to nullify it</li>
<li>Correct execution: No one (not even the trusted coordinator) should be able to produce a false tally of votes</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-overview">System Overview<a href="#system-overview" class="hash-link" aria-label="Direct link to System Overview" title="Direct link to System Overview">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="roles">Roles<a href="#roles" class="hash-link" aria-label="Direct link to Roles" title="Direct link to Roles">​</a></h3>
<p>In the MACI workflow, there are two different roles: users (voters) and a single trusted coordinator. The users vote on the blockchain via MACI smart contracts, and the coordinator tallies up the votes and releases the final results.</p>
<p>The coordinators must use zk-SNARKs to prove that their final tally result is valid without releasing the vote of every individual. Therefore, even if a coordinator is corrupt, they are unable to change a user’s vote or add extra votes themselves. A corrupt coordinator can stop a vote by never publishing the results, but they can’t publish false results.</p>
<p>Before sending their vote on the blockchain, users encrypt their vote using a shared key that only the user and coordinator can know. This key scheme is designed so that every individual user shares a distinct key with the coordinator. This prevents any bribers from simply reading the transaction data to see which option a user voted for. The encrypted vote is now considered a “message” and the user sends this message to a MACI smart contract to be stored on-chain.</p>
<p>A very simplified illustration of this encryption can be seen below:</p>
<p><img loading="lazy" alt="Posting a Message" src="/assets/images/MACI_Simple_Message-1710b449c221903f868570d29a52a24b.png" width="1040" height="560" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vote-overriding-and-public-key-switching">Vote Overriding and Public Key Switching<a href="#vote-overriding-and-public-key-switching" class="hash-link" aria-label="Direct link to Vote Overriding and Public Key Switching" title="Direct link to Vote Overriding and Public Key Switching">​</a></h3>
<p>Before a user can cast a vote, they must sign up by sending the public key they wish to use to vote to a MACI smart contract. This public key acts as their identity when voting. They can vote from any address, but their message must contain a signature from that public key. When casting an actual vote after signing up, a user will bundle a few variables — including a public key, their vote option, their vote amount, and a few others — into what is called a “command”. Then, the user signs the command with the public key they originally used to sign up. After that, the user encrypts the signature and command together so that it is now considered a message. This more complex description of how a message is constructed is illustrated below:</p>
<p><img loading="lazy" alt="Complex Message" src="/assets/images/MACI_Complex_Message-d449b3bccc2ba2dc5920ebadd976ef70.png" width="860" height="820" class="img_ev3q"></p>
<p>Users are able to override their previous vote as long as they sign their command with the previous public key. If the command is properly signed by the user’s previous public key, then the message is considered valid and the coordinator will count this as the correct vote. So, when a user provides a public key in their vote that is different than their previous public key, they may now submit a new vote signed by this new public key to override their previous vote. If the signature is not from the previous public key, the message will be marked as invalid and not counted toward the tally. Therefore, the public key can be thought of as the user’s voting username, and the signature is the voting password. If they provide the correct signature, they can submit a vote or change their public key — or both.</p>
<p>This feature, which I refer to as public key switching, is designed to counter the bribery attack where a user simply shows the briber their message, and then decrypts it for the briber to see which way the user voted. Public key switching allows users to change their public key and create invalid messages in favor of the bribers. The bribers have no way of telling if the user switched their public keys before sending in the vote shown to the bribers.</p>
<p>This can be quite confusing so here is an example:</p>
<ol>
<li>Bob signs up with public key 1</li>
<li>Bob then creates a command that contains — a vote for option A and public key 2</li>
<li>Bob signs this command with public key 1, the key he used to sign up</li>
<li>Bob encrypts this command into a message and submits it to the MACI smart contracts</li>
<li>The coordinator decrypts this message, and checks to ensure that the command is signed by Bob’s previous key — public key 1. This message is valid.</li>
<li>The coordinator then records Bob’s vote for option A and updates his public key to public key 2</li>
</ol>
<p><img loading="lazy" alt="Signup 1" src="/assets/images/MACI_Bob_SignUp_1-6f8ca29ab045d7800f9ab827f9736ebe.png" width="1337" height="744" class="img_ev3q"></p>
<p>At this point, Bob has successfully voted for option A, and in order to override this vote must send in a new vote with a signature from public key 2. At this point, a briber now tries to get Bob to vote for option B:</p>
<ol>
<li>Bob creates a command that contains — a vote for option B and public key 1</li>
<li>Bob signs this command with public key 1, encrypts the message and submits it to the MACI smart contracts</li>
<li>Bob shows the briber the decrypted message as proof of his vote for option B</li>
<li>The coordinator decrypts Bob’s message and sees that the signature does not match up with public key 2 — Bob’s previous key added in his previous message. Therefore this message is invalid and this vote is not counted in the final tally.</li>
<li>The briber has no way of knowing whether the vote was valid or invalid, and so is not incentivized to offer bribes to other users.</li>
</ol>
<p><img loading="lazy" alt="Signup 2" src="/assets/images/MACI_Bob_SignUp_2-e65ab81b9056a282a46873a53476d082.png" width="2940" height="1462" class="img_ev3q"></p>
<p>In order to get a good idea of how MACI works, it’s important to know how the zk-SNARKs are able to prove that the coordinator decrypted each message and tallied the votes properly. The next section gives a quick and much oversimplified overview of zk-SNARKs, although the readings listed in the introduction are much more helpful.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zk-snarks">zk-SNARKs<a href="#zk-snarks" class="hash-link" aria-label="Direct link to zk-SNARKs" title="Direct link to zk-SNARKs">​</a></h3>
<p>Essentially, zk-SNARKs allow users to prove they know an answer to a specific mathematical equation, without revealing what that answer is. Take the following equation for example,</p>
<blockquote>
<p>X + Y = 15</p>
</blockquote>
<p>I can prove that I know 2 values, X and Y that satisfy the equation without revealing what those two values are. When I create a zk-SNARK for my answer, anyone can use the SNARK (a group of numbers) and validate it against the equation above to prove that I do know a solution to that equation. The user is unable to use the SNARK to find out my answers for X and Y.</p>
<p>For MACI, the equation is much more complicated but can be summarized as the following equations:</p>
<blockquote>
<p>encrypt(command1) = message1<br>
<!-- -->encrypt(command2) = message2<br>
<!-- -->encrypt(command3) = message3<br>
<!-- -->…<br>
<!-- -->Command1 from user1 + command2 from user2 + command3 from user3 + … = total tally result</p>
</blockquote>
<p>Here, everyone is able to see the messages on the blockchain and the total tally result. Only the coordinator knows what the individual commands/votes are by decrypting the messages. So, the coordinator uses a zk-SNARK to prove they know all of the votes that:</p>
<ol>
<li>Encrypt to the messages present on the blockchain</li>
<li>Sum to the tally result
Users can then use the SNARK to prove that the tally result is correct, but cannot use it to prove any individual’s vote choices.</li>
</ol>
<p>Now that the core components of MACI have been covered, it is helpful to dive deeper into the MACI workflow and specific smart contracts.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="workflow">Workflow<a href="#workflow" class="hash-link" aria-label="Direct link to Workflow" title="Direct link to Workflow">​</a></h2>
<p>The general workflow process can be broken down into 4 different phases:</p>
<ol>
<li>Sign Up</li>
<li>Publish Message</li>
<li>Process Messages</li>
<li>Tally Results</li>
</ol>
<p>These phases make use of 3 main smart contracts — MACI, Poll and ​​PollProcessorAndTallyer. These contracts can be found on the MACI github page. The MACI contract is responsible for keeping track of all the user sign ups by recording the initial public key for each user. When a vote is going to take place, users can deploy a Poll smart contract via MACI.deployPoll().</p>
<p>The Poll smart contract is where users submit their messages. One MACI contract can be used for multiple polls. In other words, the users that signed up to the MACI contract can vote on multiple issues, with each issue represented by a distinct Poll contract.</p>
<p>Finally, the PollProcessorAndTallyer contract is used by the coordinator to prove on-chain that they are correctly tallying each vote. This process is explained in more detail in the Process Messages and Tally Results sections below.</p>
<p><img loading="lazy" alt="MACI Workflow" src="/assets/images/MACI_Contracts-48ece9d758b096623f02b0195e29aaf2.png" width="1100" height="575" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sign-up">Sign Up<a href="#sign-up" class="hash-link" aria-label="Direct link to Sign Up" title="Direct link to Sign Up">​</a></h3>
<p>The sign up process for MACI is handled via the MACI.sol smart contract. Users need to send three pieces of information when calling MACI.signUp():</p>
<ol>
<li>Public Key</li>
<li>Sign Up Gatekeeper Data</li>
<li>Initial Voice Credit Proxy Data</li>
</ol>
<p>The public key is the original public key mentioned in above sections that the user will need to vote. As explained in earlier sections, they can change this public key later once voting starts. The user’s public key used to sign up is shared amongst every poll.</p>
<p>MACI allows the contract creator/owner to set a “signUpGateKeeper”. The sign up gatekeeper is meant to be the address of another smart contract that determines the rules to sign up. So, when a user calls MACI.signUp(), the function will call the sign up gatekeeper to check if this user is valid to sign up.</p>
<p>MACI also allows the contract creator/owner to set an “initialVoiceCreditProxy”. This represents the contract that determines how many votes a given user gets. So, when a user calls MACI.signUp(), the function will call the initial voice credit proxy to check how many votes they can spend. The user’s voice credit balance is reset to this number for every new poll.</p>
<p>Once MACI has checked that the user is valid and retrieved how many voice credits they have, MACI stores the following user info into the Sign Up Merkle Tree:</p>
<ol>
<li>Public Key</li>
<li>Voice Credits</li>
<li>Timestamp</li>
</ol>
<p><img loading="lazy" alt="Signup" src="/assets/images/MACI_Sign_Up-2d181cded45b3811feaa0db16b4388ad.png" width="1220" height="740" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="publish-message">Publish Message<a href="#publish-message" class="hash-link" aria-label="Direct link to Publish Message" title="Direct link to Publish Message">​</a></h3>
<p>Once it is time to vote, the MACI creator/owner will deploy a Poll smart contract. Then, users will call Poll.publishMessage() and send the following data:</p>
<ol>
<li>Message</li>
<li>Encryption Key</li>
</ol>
<p>As explained in sections above, the coordinator will need to use the encryption key in order to derive a shared key. The coordinator can then use the shared key to decrypt the message into a command, which contains the vote.</p>
<p>Once a user publishes their message, the Poll contract will store the message and encryption key into the Message Merkle Tree.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="process-messages">Process Messages<a href="#process-messages" class="hash-link" aria-label="Direct link to Process Messages" title="Direct link to Process Messages">​</a></h3>
<p>Once the voting is done for a specific poll, the coordinator will use the PollProcessAndTallyer contract to first prove that they have correctly decrypted each message and applied them to correctly create an updated state tree. This state tree keeps an account of all the valid votes that should be counted. So, when processing the messages, the coordinator will not keep messages that are later overridden by a newer message inside the state tree. For example, if a user votes for option A, but then later sends a new message to vote for option B, the coordinator will only count the vote for option B.</p>
<p>The coordinator must process messages in groups so that proving on chain does not exceed the data limit. The coordinator then creates a zk-SNARK proving their state tree correctly contains only the valid messages. Once the proof is ready, the coordinator calls PollProcessorAndTallyer.processMessages(), providing a hash of the state tree and the zk-SNARK proof as an input parameters.</p>
<p>The PollProcessorAndTallyer contract will send the proof to a separate verifier contract. The verifier contract is specifically built to read MACI zk-SNARK proofs and tell if they are valid or not. So, if the verifier contract returns true, then everyone can see on-chain that the coordinator correctly processed that batch of messages. The coordinator repeats this process until all messages have been processed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tally-votes">Tally Votes<a href="#tally-votes" class="hash-link" aria-label="Direct link to Tally Votes" title="Direct link to Tally Votes">​</a></h3>
<p>Finally, once all messages have been processed, the coordinator tallies the votes of the valid messages. The coordinator creates a zk-SNARK proving that the valid messages in the state tree (proved in Process Messages step) contain votes that sum to the given tally result. Then, they call PollProcessorAndTallyer.tallyVotes() with a hash of the correct tally results and the zk-SNARK proof. Similarly to the processMessages function, the tallyVotes function will send the proof to a verifier contract to ensure that it is valid.</p>
<p>The tallyVotes function is only successful if the verifier contract returns that the proof is valid. Therefore, once the tallyVotes function succeeds, users can trust that the coordinator has correctly tallied all of the valid votes. After this step, anyone can see the final tally results and the proof that these results are a correct result of the messages sent to the Poll contract. The users won’t be able to see how any individual voted, but will be able to trust that these votes were properly processed and counted.</p>
<p><img loading="lazy" alt="Tally" src="/assets/images/MACI_Verifier_1-a65417ccac284c2f27c698dd2b7030b9.png" width="1180" height="470" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>MACI is a huge step forward in preventing collusion for on-chain votes. While it doesn’t prevent all possibilities of collusion, it does make it much harder. MACI can already be seen to be in use by the clr.fund, which has users vote on which projects to receive funding. When the possible funding amount becomes very large, users and organizations have a large incentive to collude to receive parts of these funds. This is where MACI can truly make a difference, to protect the fairness of such important voting processes such as those at clr.fund.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/zk">zk</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/maci">maci</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/release">release</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/voting">voting</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/security">security</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/privacy-scaling-explorations/maci/edit/dev/website/blog/2022-09-22-maci-v1-technical-introduction.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/maci-v1-1-1-release"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Maci v1.1.1 Release</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/maci-1-0-release"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MACI 1.0 Release</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#system-overview" class="table-of-contents__link toc-highlight">System Overview</a><ul><li><a href="#roles" class="table-of-contents__link toc-highlight">Roles</a></li><li><a href="#vote-overriding-and-public-key-switching" class="table-of-contents__link toc-highlight">Vote Overriding and Public Key Switching</a></li><li><a href="#zk-snarks" class="table-of-contents__link toc-highlight">zk-SNARKs</a></li></ul></li><li><a href="#workflow" class="table-of-contents__link toc-highlight">Workflow</a><ul><li><a href="#sign-up" class="table-of-contents__link toc-highlight">Sign Up</a></li><li><a href="#publish-message" class="table-of-contents__link toc-highlight">Publish Message</a></li><li><a href="#process-messages" class="table-of-contents__link toc-highlight">Process Messages</a></li><li><a href="#tally-votes" class="table-of-contents__link toc-highlight">Tally Votes</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Documentation</a></li><li class="footer__item"><a href="https://github.com/privacy-scaling-explorations/maci" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.com/invite/sF5CT5rzrR" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/zkMACI" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Privacy and Scaling Explorations</div></div></div></footer></div>
</body>
</html>