<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Minimum Anti-Collusion Infrastructure</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="primitives.html"><strong aria-hidden="true">3.</strong> MACI Primitives</a></li><li class="chapter-item expanded "><a href="cli.html"><strong aria-hidden="true">4.</strong> Command-line interface</a></li><li class="chapter-item expanded "><a href="contracts.html"><strong aria-hidden="true">5.</strong> Smart Contracts</a></li><li class="chapter-item expanded "><a href="circuits.html"><strong aria-hidden="true">6.</strong> Circuits</a></li><li class="chapter-item expanded "><a href="trustedsetup.html"><strong aria-hidden="true">7.</strong> Trusted setup</a></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">8.</strong> Testing</a></li><li class="chapter-item expanded "><a href="integrating-maci.html"><strong aria-hidden="true">9.</strong> Integrating MACI</a></li><li class="chapter-item expanded "><a href="audit.html"><strong aria-hidden="true">10.</strong> Latest audit</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Minimum Anti-Collusion Infrastructure</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Minimum Anti-Collusion Infrastructure (MACI) is a base layer for
bribery-resistant, secure, and private digital voting.</p>
<p>Applications like <a href="https://clr.fund/">clr.fund</a> build atop MACI to increase
privacy and discourage bribery for public goods funding.</p>
<p>MACI offers the following guarantees:</p>
<ul>
<li><strong>Collusion resistance</strong>: no-one except a trusted coordinator should be
certain of the validity of a vote, reducing the effectiveness of bribery.</li>
<li><strong>Receipt-freeness</strong>: no voter should be able to prove (besides to the coordinator) which way they voted.</li>
<li><strong>Privacy</strong>: no-one except a trusted coordinator should be able to decrypt a
vote.</li>
<li><strong>Uncensorability</strong>: no-one — not even the trusted coordinator — should be
able to censor a vote.</li>
<li><strong>Unforgeability</strong>: only the owner of a user's private key may cast a vote
tied to its corresponding public key.</li>
<li><strong>Non-repudiation</strong>: no-one may modify or delete a vote after it is cast,
although a user may cast another vote to nullify it.</li>
<li><strong>Correct execution</strong>: no-one — not even the trusted coordinator — should be
able to produce a false tally of votes.</li>
</ul>
<p>Under the hood, MACI uses Ethereum smart contracts and zero-knowledge proofs.
It inherits security and uncensorability from the underlying Ethereum
blockchain, ensures unforgeability via asymmetric encryption, and achieves
collusion resistance, privacy, and correct execution via zk-SNARK proofs.</p>
<p>Although MACI can provide collusion resistance only if the coordinator is
honest, a dishonest coordinator can neither censor nor tamper with its
execution.</p>
<p>Note that MACI presumes an identity system where each legitimate member
controls a unique Ethereum private key.</p>
<p>MACI was originally proposed by Vitalik Buterin in <a href="https://ethresear.ch/t/minimal-anti-collusion-infrastructure/5413">this ethresear.ch
post</a>.</p>
<h2 id="credits"><a class="header" href="#credits">Credits</a></h2>
<ul>
<li><a href="https://github.com/barryWhiteHat">Barry WhiteHat</a></li>
<li><a href="https://github.com/corydickson">Cory Dickson</a></li>
<li><a href="https://twitter.com/ChihChengLiang">Chih-Cheng Liang</a></li>
<li><a href="https://han0110.github.io/">Han Jian</a></li>
<li><a href="https://kndrck.co/">Kendrick Tan</a></li>
<li><a href="https://github.com/xuhcc">Kirill Goncharov</a></li>
<li><a href="http://kobi.one/">Kobi Gurkan</a></li>
<li><a href="https://kohweijie.com">Koh Wei Jie</a></li>
<li><a href="https://twitter.com/xGozzy">Samuel Gosling</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>You need the following to use MACI:</p>
<ul>
<li>An x86-64 system</li>
<li>A Linux system, preferably a Debian-based distribution like Ubuntu</li>
<li>Node.js: use <a href="https://github.com/nvm-sh/nvm"><code>nvm</code></a> to install it. MACI has
been tested with Node 14, 16 and 18. We do however recommend to use Node 18 as Node 14 is deprecated and Node 16 will soon be deprecated too.</li>
<li>The <code>libgmp-dev</code> <code>nlohmann-json3-dev</code> <code>nasm</code> and <code>g++</code> Debian/Ubuntu
packages. They are needed to run <code>circom-helper</code>, which in turn is used to
develop and test zk-SNARK circuits.</li>
<li>The <a href="https://github.com/iden3/rapidsnark"><code>rapidsnark</code></a> tool.</li>
</ul>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<h3 id="install-rapidsnark"><a class="header" href="#install-rapidsnark">Install <code>rapidsnark</code></a></h3>
<p>First, install dependencies:</p>
<pre><code class="language-bash">sudo apt-get install build-essential libgmp-dev libsodium-dev nasm git
</code></pre>
<p>Next, clone <code>rapidsnark</code> and build it:</p>
<pre><code class="language-bash">git clone https://github.com/iden3/rapidsnark.git &amp;&amp; \
cd rapidsnark &amp;&amp; \
git checkout 1c13721de4a316b0b254c310ccec9341f5e2208e

npm install &amp;&amp; \
git submodule init &amp;&amp; \
git submodule update &amp;&amp; \
npx task createFieldSources &amp;&amp; \
npx task buildProver
</code></pre>
<p>Note the location of the <code>rapidsnark</code> binary (e.g.
<code>/home/user/rapidsnark/build/prover</code>).</p>
<p>Next, install circom v2:</p>
<p>https://docs.circom.io/</p>
<p>Note the location of the <code>circom</code> binary (e.g. <code>$HOME/.cargo/bin/circom</code>), as you will need it later.</p>
<h3 id="install-maci"><a class="header" href="#install-maci">Install MACI</a></h3>
<pre><code class="language-bash">git clone https://github.com/privacy-scaling-explorations/maci.git &amp;&amp; \
cd maci &amp;&amp; \
npm i &amp;&amp; \
npm run bootstrap &amp;&amp; \
npm run build
</code></pre>
<p>Install dependencies for <code>circom-helper</code> and <code>zkey-manager</code>:</p>
<pre><code class="language-bash">sudo apt-get install libgmp-dev nlohmann-json3-dev nasm g++
</code></pre>
<h3 id="configure-circom-helper-and-zkey-manager"><a class="header" href="#configure-circom-helper-and-zkey-manager">Configure circom-helper and zkey-manager</a></h3>
<p>Edit <code>circuits/circomHelperConfig.json</code> to include the relative path to the
circom binary.</p>
<pre><code class="language-json">{
  &quot;circom&quot;: &quot;RELATIVE_PATH_TO_CIRCOM&quot;,
  &quot;snarkjs&quot;: &quot;./node_modules/snarkjs/build/cli.cjs&quot;,
  &quot;circuitDirs&quot;: [&quot;./circom/test/&quot;]
}
</code></pre>
<p>Edit <code>cli/zkeys.config.yml</code> to include the relative path to the
circom binary.</p>
<pre><code class="language-yml">
---
circomPath: &quot;RELATIVE_PATH_TO_CIRCOM&quot;
</code></pre>
<h3 id="download-zkey-files"><a class="header" href="#download-zkey-files">Download <code>.zkey</code> files</a></h3>
<p>MACI has two zk-SNARK circuits. Each circuit is parameterised. There should one
<code>.zkey</code> file for each circuit and set of parameters.</p>
<p>Unless you wish to generate a fresh set of <code>.zkey</code> files, you should obtain
them from someone who has performed a multi-party trusted setup for said
circuits..</p>
<p>Note the locations of the <code>.zkey</code> files as the CLI requires them as
command-line flags.</p>
<h3 id="generate-zkey-files"><a class="header" href="#generate-zkey-files">Generate <code>.zkey</code> files</a></h3>
<p>If you wish to generate <code>.zkey</code> files from scratch, first navigate to <code>cli/</code>
and edit <code>zkeys.config.yml</code>. Set the parameters you need.</p>
<p>Next, run the following to compile the circuits with parameters you specified:</p>
<pre><code class="language-bash">npx zkey-manager compile -c zkeys.config.yml
</code></pre>
<p>Next, download the <code>.ptau</code> file:</p>
<pre><code class="language-bash">npx zkey-manager downloadPtau -c zkeys.config.yml
</code></pre>
<p>Finally, generate the <code>.zkey</code> files. This may require a lot of memory and time.</p>
<pre><code class="language-bash">npx zkey-manager genZkeys -c zkeys.config.yml
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="maci-primitives"><a class="header" href="#maci-primitives">MACI primitives</a></h2>
<p>This section provides a short introduction of the main primitives used by MACI.</p>
<h3 id="elliptic-curves"><a class="header" href="#elliptic-curves">Elliptic Curves</a></h3>
<p>MACI uses the Baby Jubjub Elliptic <a href="https://iden3-docs.readthedocs.io/en/latest/_downloads/33717d75ab84e11313cc0d8a090b636f/Baby-Jubjub.pdf">Curve</a>. The <code>p</code> scalar field of choosing is:</p>
<p>$p=21888242871839275222246405745257275088548364400416034343698204186575808495617$</p>
<p>with generator:</p>
<p>$995203441582195749578291179787384436505546430278305826713579947235728471134$
$5472060717959818805561601436314318772137091100104008585924551046643952123905$</p>
<p>and within the finite field with modulo $p$.</p>
<h3 id="key-pairs"><a class="header" href="#key-pairs">Key Pairs</a></h3>
<p>MACI uses Node.js's <code>crypto.randomBytes(32)</code> function to generate a cryptographically strong pseudorandom 32-byte value, as well as an algorithm to prevent modulo bias. In pseudocode this is:</p>
<pre><code class="language-python">lim = 2 ** 256
min = lim - p
rand = null
while true:
    rand = BigInt(crypto.getRandomBytes(32))
    if rand &gt;= min:
        break

privKey = rand % p
</code></pre>
<p>A public key is a point on the Baby Jubjub <a href="https://iden3-docs.readthedocs.io/en/latest/_downloads/33717d75ab84e11313cc0d8a090b636f/Baby-Jubjub.pdf">curve</a>, which is deterministically derived from a private key <code>s</code>.</p>
<h3 id="message-signing"><a class="header" href="#message-signing">Message Signing</a></h3>
<p>To sign messages, MACI uses the Edwards-curve Digital Signature Algorithm (EdDSA), implemented by <a href="https://iden3-docs.readthedocs.io/en/latest/iden3_repos/research/publications/zkproof-standards-workshop-2/ed-dsa/ed-dsa.html#ed-dsa">iden3</a>.</p>
<h3 id="hash-functions"><a class="header" href="#hash-functions">Hash Functions</a></h3>
<p>MACI uses the Poseidon hash function, which is proven to be very efficient in ZK applications. Poseidon accepts $n$ inputs and produces 1 output:</p>
<p>$y = \mathsf{poseidon_n}([x_1, x_2, ..., x_n])$</p>
<p>Also, SHA256 is used to compress public inputs to a circuit into a single field element in the finite field $F$ mod $p$.</p>
<h3 id="message-encryption"><a class="header" href="#message-encryption">Message Encryption</a></h3>
<p>In order to encrypt messages, MACI uses Poseidon in DuplexSponge <a href="https://dusk.network/uploads/Encryption-with-Poseidon.pdf">mode</a>. This provides an encryption function and a decryption function:</p>
<ul>
<li>$C$ as $\mathsf{poseidonEncrypt}(k_s[0], k_s[1], N, l, t[])$</li>
<li>$\mathsf{poseidonDecrypt}(k_s[0], k_s[1], N, l, C)$</li>
</ul>
<p>In more details,</p>
<ul>
<li>$k_s$ is the shared key, a point on the Baby Jubjub curve</li>
<li>$N$ is the nonce, which we hardcode to 0</li>
<li>$l$ is the length of the plaintext $t[]$</li>
</ul>
<p>The implementation can be found <a href="https://github.com/weijiekoh/circomlib/">here</a>.</p>
<h3 id="shared-key-generation"><a class="header" href="#shared-key-generation">Shared Key Generation</a></h3>
<p>The ECDH algorithm is used to generate a shared key, which is then used to encrypt each message. This allows to create messages which are only decryptable by the coordinator and the person sending the message.</p>
<p>In more details:</p>
<ul>
<li>
<p>The coordinator's public key $cPk$ is known to all. Their private key $cSk$ is secret.</p>
</li>
<li>
<p>When the user publishes a message (i.e. casts a vote), they generate an ephemeral keypair with private key $eSk$ and public key $ePk$.</p>
</li>
<li>
<p>The user generates the shared key $k$ using the coordinator's public key $cPk$ and the user's ephemeral private key $eSk$.</p>
</li>
<li>
<p>The user encrypts the command and signature with $k$ to form a message.</p>
</li>
<li>
<p>The user sends their ephemeral public key $ePk$ along with the ciphertext. The coordinator can recover the same shared key using their private key $cSk$ and the given ephemeral public key $ePk$.</p>
</li>
</ul>
<h3 id="merkle-trees"><a class="header" href="#merkle-trees">Merkle Trees</a></h3>
<p>Rather than using Binary merkle trees, MACI uses Quinary merkle trees (5 leaves per node). This allows for more gas efficient computation using the Poseidon hash function.</p>
<h4 id="accumulator-queue"><a class="header" href="#accumulator-queue">Accumulator queue</a></h4>
<p>This contract holds user sign-ups and messages. When a leaf is inserted into the <code>AccQueue</code>, the merkle root is not updated yet, instead the leaf is updated or the root of a subtree is re-computed. The smart contract exposes three functions:</p>
<ul>
<li><code>enqueue(leaf)</code>: Enqueues a leaf into a subtree
four out of five times it is invoked, an enqueue operation may or may not require the contract to perform a hash function. When it does, only up to $t_d$ required number of hashes need to be computed</li>
<li><code>mergeSubRoots()</code>: Merge all subtree roots into the shortest possible Merkle tree to fit
Before computing the main Merkle root, it is necessary to compute the smallSRTroot (the smallest subroot tree root). This is the Merkle root of a tree which is small enough to fit all the subroots
function which allows the coordinator to specify the number of queue operations to execute. The entire tree may be merged in a single transaction, or it may not.</li>
<li><code>merge()</code>: Calculate the Merkle root of all the leaves at height $d_t$</li>
</ul>
<h3 id="domain-objects"><a class="header" href="#domain-objects">Domain Objects</a></h3>
<h4 id="verifying-keys"><a class="header" href="#verifying-keys">Verifying Keys</a></h4>
<p>A verifying key $vk$ is comprised of the following elements:</p>
<ol>
<li>$\alpha$, a point in the curve on which $G_1$ is defined</li>
<li>$\beta$, a point in the curve on which $G_2$ is defined</li>
<li>$\gamma$, a point in the curve on which $G_2$ is defined</li>
<li>$\delta$, a point in the curve on which $G_2$ is defined</li>
<li>$ic[]$, a list of points in the curve on which $G_1$ is defined</li>
</ol>
<p>A verifying key is used to validate a zk-SNARK proof. Each unique permutation of parameters to a particular circuit has a different verifying key.</p>
<h4 id="private-keys"><a class="header" href="#private-keys">Private Keys</a></h4>
<p>MACI's private keys allow users to send and decrypt messages. This key translates to a scalar point on the Baby Jubjub ellpitic curve. All keys are serialized with the prefix <code>macisk</code>.</p>
<h4 id="public-keys"><a class="header" href="#public-keys">Public Keys</a></h4>
<p>Public keys also translate to a point on the Baby Jubjub elliptic curve, and is derived from the private key $k$. These are serialized with the prefix <code>macipk</code>.</p>
<h4 id="key-pair"><a class="header" href="#key-pair">Key Pair</a></h4>
<p>A Key Pair is a private key and its corresponding public key.</p>
<h4 id="command"><a class="header" href="#command">Command</a></h4>
<p>A command represents an action that a user may take. Such as casting a vote in a poll or changing their public key if bribed. It is made up of the following parameters:</p>
<table><thead><tr><th>Symbol</th><th>Name</th><th>Size</th><th>Description</th></tr></thead><tbody>
<tr><td>$cm_i$</td><td>State index</td><td>50</td><td>State leaf index where the signing key is located</td></tr>
<tr><td>$cm_{p_{x}}$</td><td>Public key x-coordinate</td><td>253</td><td>If no change is necessary this parameter should reflect the current public key's x-coordinate</td></tr>
<tr><td>$cm_{p_{y}}$</td><td>Public key y-coordinate</td><td>253</td><td>If no change is necessary this parameter should reflect the current public key's y-coordinate</td></tr>
<tr><td>$cm_{i_{v}}$</td><td>Vote option index</td><td>50</td><td>Option state leaf index of preference to assign the vote for</td></tr>
<tr><td>$cm_w$</td><td>Voting weight</td><td>50</td><td>Voice credit balance allocation, this is an arbitary value dependent on a user's available credits</td></tr>
<tr><td>$cm_n$</td><td>Nonce</td><td>50</td><td>State leaf's index of actions committed plus one</td></tr>
<tr><td>$cm_{id}$</td><td>Poll id</td><td>50</td><td>The poll's identifier to cast in regard to</td></tr>
<tr><td>$cm_s$</td><td>Salt</td><td>253</td><td>An entropy value to inhibit brute force attacks</td></tr>
</tbody></table>
<h4 id="message"><a class="header" href="#message">Message</a></h4>
<p>A message is an encrypted command using the shared key $k_s$ between the voter and the coordinator. The plaintext $t$ is computed as such:</p>
<p>$t = [p, cm_{p_{x}}, cm_{p_{y}}, cm_s, R8[0], R8[1], S]$</p>
<p>While the message can be computed with the formula below:</p>
<p>$M$ = $\mathsf{poseidonEncrypt}(k_s[0], k_s[1], cm_n, 7, t)$</p>
<h4 id="decrypting-a-message"><a class="header" href="#decrypting-a-message">Decrypting a message</a></h4>
<p>To decrypt a message using $k_s$ is expressed as</p>
<p>$[p, R8[0], R8[1], cm_s]$ = $\mathsf{poseidonDecrypt}(M, k_s[0], k_s[1], cm_n, 7)$</p>
<p>To unpack $p$ to it's original five parameters, it must be seperated into 50 bit values from the parent 250 bit value. To extract 50 bits at byte $n$, we:</p>
<ol>
<li>initialise 50 bits</li>
<li>shift left by $n$ bits</li>
<li>bitwise AND with $p$</li>
<li>shift right by $n$ bits</li>
</ol>
<h3 id="ballot"><a class="header" href="#ballot">Ballot</a></h3>
<p>A Ballot represents a particular user's votes in a poll, as well as their next valid nonce. It is akin to a voting slip, which belongs to only one voter and contains a list of their choices.</p>
<table><thead><tr><th>Symbol</th><th>Name</th><th>Comments</th></tr></thead><tbody>
<tr><td>$blt_{v}$</td><td>An array of vote weights</td><td>$blt_{v[i]}$ refers to the vote weights assigned to vote option $i$</td></tr>
<tr><td>$blt_n$</td><td>The current nonce</td><td>Starts from 0 and increments, so the first valid command must have nonce 1</td></tr>
<tr><td>$blt_d$</td><td>The vote option tree depth</td><td></td></tr>
</tbody></table>
<p>The hash $blt$ is computed as such:</p>
<ol>
<li>Compute the Merkle root of $blt_v$, arity 5, of a tree of depth $blt_d$; let this value be $blt_r$</li>
<li>Compute $\mathsf{poseidon_2}([blt_n, blt_r])$</li>
</ol>
<h3 id="state-leaf"><a class="header" href="#state-leaf">State leaf</a></h3>
<p>A state leaf represents a user's participation declared through an identity (their public key) and information relevant to their ability or right to cast votes in a poll (their voice credit balance and the block timestamp at which they signed up).</p>
<p>We define a state leaf $sl$ as the $\mathsf{poseidon_4}$ hash of the following:</p>
<table><thead><tr><th>Symbol</th><th>Name</th><th>Comments</th></tr></thead><tbody>
<tr><td>$sl_{P_x}$</td><td>Public key's x-coordinate</td><td></td></tr>
<tr><td>$sl_{P_y}$</td><td>Public key's y-coordinate</td><td></td></tr>
<tr><td>$sl_{v}$</td><td>Voice credit balance</td><td></td></tr>
<tr><td>$sl_{t}$</td><td>Block timestamp</td><td>In Unix time (seconds since Jan 1 1970 UTC)</td></tr>
</tbody></table>
<p>The hash $sl$ is computed as such:</p>
<p>$sl = \mathsf{poseidon_4}([sl_{A_x}, sl_{A_y}, sl_{v}, sl_{t}])$</p>
<h4 id="blank-state-leaf"><a class="header" href="#blank-state-leaf">Blank state leaf</a></h4>
<p>A blank state leaf $sl_B$ has the following value:</p>
<p>$6769006970205099520508948723718471724660867171122235270773600567925038008762$</p>
<p>This value is computed as such:</p>
<p>$A_{b_x} = 10457101036533406547632367118273992217979173478358440826365724437999023779287$
$A_{b_y} = 19824078218392094440610104313265183977899662750282163392862422243483260492317$
$sl_B = \mathsf{poseidon_4}([A_{b0}, A_{b1}, 0, 0])$</p>
<p>The code to derive $A_{b_x}$ and $A_{b_y}$ is <a href="https://github.com/iden3/circomlib/blob/d5ed1c3ce4ca137a6b3ca48bec4ac12c1b38957a/src/pedersen_printbases.js">here</a>. The function call required is <code>pedersenHash.getBasePoint('blake', 0)</code></p>
<ol>
<li>Hash the string <code>PedersenGenerator_00000000000000000000000000000000_00000000000000000000000000000000</code> with $\mathsf{blake_{256}}$. In big-endian hexadecimal format, the hash should be <code>1b3ef77ef2cd620fd2358e69dd564f35556aad552fdd7f06b777bd3a1d697160</code>.</li>
<li>Set the 255th bit to 0. The result should be <code>1b3ef77ef2cd620fd2358e69dd564f35556aad552fdd7f06b777bd3a1d697120</code>.</li>
<li>Use the method to convert a buffer to a point on the BabyJub curve described in [2.3.2].</li>
<li>Multiply the point by 8. The result is the point with x-value $A_{b_x}$ and y-value $A_{b_y}$</li>
</ol>
<p>Given the <a href="https://wstein.org/edu/2007/spring/ent/ent-html/node89.html">elliptic curve discrete logarithm problem</a>, we assume that no-one knows the private key $s \in \mathbb{F}<em>p$ and by using the public key generation procedure in [1.4], we can derive $A</em>{b_x}$ and $A_{b_y}$. Furthermore, the string above (<code>PedersenGenerator...</code>) acts as a nothing-up-my-sleeve value.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="command-line-interface"><a class="header" href="#command-line-interface">Command-line interface</a></h1>
<p>MACI provides a command-line interface that allows for effective deployment and
testing. Applications that build on top of MACI, such as
<a href="https://clr.fund/">clr.fund</a>, implement their own web UIs.</p>
<p>Note that all the example commands default to a local Ethereum testnet at
<code>http://localhost:8545</code>, and use the Ethereum private key
<code>0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3</code>. Do not
send any real funds to the address generated by this key.</p>
<p>For testing purposes, you can run:</p>
<pre><code class="language-bash"># in maci/contracts
npm run hardhat
</code></pre>
<h2 id="subcommands"><a class="header" href="#subcommands">Subcommands</a></h2>
<table><thead><tr><th>Role</th><th>Action</th><th>Subcommand</th></tr></thead><tbody>
<tr><td>User</td><td>Generate MACI keypair</td><td><code>genMaciKeypair</code></td></tr>
<tr><td>User</td><td>Generate MACI public key</td><td><code>genMaciPubkey</code></td></tr>
<tr><td>Coordinator</td><td>Deploy VkRegistry</td><td><code>deployVkRegistry</code></td></tr>
<tr><td>Coordinator</td><td>Set verifying keys</td><td><code>setVerifyingKeys</code></td></tr>
<tr><td>Coordinator</td><td>Create MACI instance</td><td><code>create </code></td></tr>
<tr><td>Coordinator</td><td>Deploy a new poll</td><td><code>deployPoll</code></td></tr>
<tr><td>Coordinator</td><td>Deploy a new poll processor and tallyer</td><td><code>deployPpt</code></td></tr>
<tr><td>User</td><td>Sign up</td><td><code>signup</code></td></tr>
<tr><td>User</td><td>Change key / vote</td><td><code>publish</code></td></tr>
<tr><td>Coordinator</td><td>Merge state tree</td><td><code>mergeSignups</code></td></tr>
<tr><td>Coordinator</td><td>Merge message tree</td><td><code>mergeMessages</code></td></tr>
<tr><td>Coordinator</td><td>Generate message processing and vote tallying proofs</td><td><code>genProofs</code></td></tr>
<tr><td>Coordinator</td><td>Submit proofs</td><td><code>proveOnChain</code></td></tr>
<tr><td>Coordinator</td><td>Process and tally all votes without producing proofs</td><td><code>processAndTallyWithoutProofs</code></td></tr>
<tr><td>Coordinator</td><td>Roll back message processing and vote tallying in the MACI contract</td><td><code>coordinatorReset</code></td></tr>
</tbody></table>
<h2 id="public-and-private-key-format"><a class="header" href="#public-and-private-key-format">Public and private key format</a></h2>
<p>MACI uses private keys in the BabyJub field for operations which occur within
zk-SNARKs, such as decrypting messages or signing commands. As MACI is deployed
on Ethereum, we seek to avoid confusing BabyJub private keys with Ethereum
private keys. To that end, users should pass serialized formats of public and
private keys to this CLI. We use <code>maci-domainobj</code>'s <code>PrivKey.serialize</code> and
<code>PubKey.serialize</code> functions to do so.</p>
<p>Examples of serialized public and private keys:</p>
<pre><code>Private key: macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e
Public key:  macipk.c974f4f168b79727ac98bfd53a65ea0b4e45dc2552fe73df9f8b51ebb0930330
</code></pre>
<h3 id="coordinator-deploy-vkregistry"><a class="header" href="#coordinator-deploy-vkregistry">Coordinator: Deploy VkRegistry</a></h3>
<p>This command deploys an instance of a VkRegistry contract. Multiple MACI
contracts can refer to the same VkRegistry as long as they are all owned (via
<code>Ownable.sol</code>) by the same account.</p>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js deployVkRegistry
</code></pre>
<p>Example output:</p>
<pre><code>VkRegistry: 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
</code></pre>
<h3 id="coordinator-set-verifying-keys"><a class="header" href="#coordinator-set-verifying-keys">Coordinator: Set verifying keys</a></h3>
<p>Note that the filename of the <code>.zkey</code> files must follow this format:</p>
<pre><code>ProcessMessages_&lt;STATE_TREE_DEPTH&gt;-&lt;MSG_TREE_DEPTH&gt;-&lt;MSG_SUBTREE_DEPTH&gt;-&lt;VOTE_OPTION_TREE_DEPTH&gt;_test.&lt;CONTRIBUTION_NUM&gt;.zkey
TallyVotes_&lt;STATE_TREE_DEPTH&gt;-&lt;INT_STATE_TREE_DEPTH&gt;-&lt;VOTE_OPTION_TREE_DEPTH&gt;&gt;_test.&lt;CONTRIBUTION_NUM&gt;&gt;.zkey
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js setVerifyingKeys \
    -s 10 -i 1 -m 2 -v 2 -b 1 \
    -p ./zkeys/ProcessMessages_10-2-1-2_test.0.zkey \
    -t ./zkeys/TallyVotes_10-1-2_test.0.zkey \
    -k 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
</code></pre>
<p>Example output:</p>
<pre><code>Generating ./zkeys/ProcessMessages_10-2-1-2_test.0.zkey.vk.json, please wait...
Generating ./zkeys/TallyVotes_10-1-2_test.0.zkey.vk.json, please wait...
Transaction hash: 0x582631c36a4e21e0b65c3f9100c6343408c8683a36ded36fc02a9be07fa079e8
</code></pre>
<h3 id="coordinator-create-maci-instance"><a class="header" href="#coordinator-create-maci-instance">Coordinator: Create MACI instance</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js create -r 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
</code></pre>
<p>Example output:</p>
<pre><code>Deploying InitialVoiceCreditProxy
Deploying Poseidon contracts
Linking Poseidon libraries to MACI
Linking Poseidon libraries to PollFactory
Linking Poseidon libraries to MessageAqFactory
Deploying MACI
Transferring PollFactory ownership to MACI
Transferring MessageAqFactory ownership to PollFactory
Initialising MACI
MACI: 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D
</code></pre>
<h3 id="coordinator-deploy-poll"><a class="header" href="#coordinator-deploy-poll">Coordinator: Deploy poll</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node ./build/index.js deployPoll \
    -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D \
    -pk macipk.c974f4f168b79727ac98bfd53a65ea0b4e45dc2552fe73df9f8b51ebb0930330 \
    -t 30 -g 25 -mv 25 -i 1 -m 2 -b 1 -v 2
</code></pre>
<p>Example output:</p>
<pre><code>Verifier: 0x5E70a420373D6BcB1ca3D08FEeB78a2F80727B29
Poll ID: 0
Poll contract: 0x710FA420C3bE4bb0730265d6581BDda11087A901
PollProcessorAndTallyer contract: 0x62C3204a98bbbd73C8fc3B8bfCDa467CB079dF47
</code></pre>
<h3 id="user-sign-up"><a class="header" href="#user-sign-up">User: sign up</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node ./build/index.js signup \
    -p macipk.c974f4f168b79727ac98bfd53a65ea0b4e45dc2552fe73df9f8b51ebb0930330 \
    -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D
</code></pre>
<p>Example output:</p>
<pre><code>Transaction hash: 0xcae04f618a0b45896732632121248c312cbc68584519c1e43932b110da9078bc
State index: 1
</code></pre>
<h3 id="user-publish-message"><a class="header" href="#user-publish-message">User: publish message</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js publish \
    -p macipk.c974f4f168b79727ac98bfd53a65ea0b4e45dc2552fe73df9f8b51ebb0930330 \
    -sk macisk.2ae4f199bf3925a2407f7c775c9261f351ab861d8e9ecbb84622bdd3f6d41b08 \
    -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D \
    -i 1 -v 0 -w 9 -n 1 -o 0
</code></pre>
<h3 id="coordinator-merge-state-tree"><a class="header" href="#coordinator-merge-state-tree">Coordinator: merge state tree</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js mergeSignups -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D -o 0
</code></pre>
<h3 id="coordinator-merge-message-tree"><a class="header" href="#coordinator-merge-message-tree">Coordinator: merge message tree</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js mergeMessages -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D -o 0
</code></pre>
<h3 id="coordinator-generate-proofs"><a class="header" href="#coordinator-generate-proofs">Coordinator: generate proofs</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">node build/index.js genProofs -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D \
    -sk macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e \
    -o 0 \
    -t tally.json \
    -f proofs.json \
    -r ~/rapidsnark/build/prover \
    -wp ./zkeys/ProcessMessages_10-2-1-2_test \
    -wt ./zkeys/TallyVotes_10-1-2_test \
    -zp ./zkeys/ProcessMessages_10-2-1-2_test.0.zkey \
    -zt ./zkeys/TallyVotes_10-1-2_test.0.zkey \
</code></pre>
<h3 id="coordinator-prove-on-chain"><a class="header" href="#coordinator-prove-on-chain">Coordinator: prove on chain</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">node build/index.js proveOnChain \
    -x 0x89962fa216d39fCcaaC11e1e462340d80ab6Cf4D \
    -o 0 \
    -q 0x62C3204a98bbbd73C8fc3B8bfCDa467CB079dF47 \
    -f proofs/
</code></pre>
<h3 id="anyone-verify-tally"><a class="header" href="#anyone-verify-tally">Anyone: verify tally</a></h3>
<p>Example usage:</p>
<pre><code class="language-bash">node build/index.js verify \
    -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -o 0 \
    -t tally.json \
    -q 0x62C3204a98bbbd73C8fc3B8bfCDa467CB079dF47
</code></pre>
<h2 id="demonstration"><a class="header" href="#demonstration">Demonstration</a></h2>
<h3 id="scenario"><a class="header" href="#scenario">Scenario:</a></h3>
<ol>
<li>Alice votes for Party A</li>
<li>Alice changes her key</li>
<li>Eve tries to bribe Alice to change her vote to Party B</li>
<li>Alice submits an invalid vote for Party B</li>
<li>The coordinator processes the votes, computes, and verifies the final tally</li>
<li>The expected result is: Party A has some votes and Party B has 0 votes.</li>
</ol>
<p>Implication: Alice's invalid vote was not counted, and Eve had no way to tell.</p>
<h3 id="examples-of-serialized-public-and-private-keys"><a class="header" href="#examples-of-serialized-public-and-private-keys">Examples of serialized public and private keys:</a></h3>
<pre><code>Coordinator:
Private key: macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e
Public key:  macipk.c974f4f168b79727ac98bfd53a65ea0b4e45dc2552fe73df9f8b51ebb0930330

Alice:
Private key: macisk.fd7aa614ec4a82716ffc219c24fd7e7b52a2b63b5afb17e81c22fe21515539c
Public key:  macipk.3e7bb2d7f0a1b7e980f1b6f363d1e3b7a12b9ae354c2cd60a9cfa9fd12917391
</code></pre>
<h3 id="coordinator-deploy-vkregistry-1"><a class="header" href="#coordinator-deploy-vkregistry-1">Coordinator: Deploy VkRegistry</a></h3>
<pre><code class="language-bash">node build/index.js deployVkRegistry
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">VkRegistry: 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
</code></pre>
<h3 id="coordinator-set-verifying-keys-1"><a class="header" href="#coordinator-set-verifying-keys-1">Coordinator: Set verifying keys</a></h3>
<pre><code class="language-bash">node build/index.js setVerifyingKeys \
    --vk_registry 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0 \
    --state-tree-depth 10 \
    --int-state-tree-depth 1 \
    --msg-tree-depth 2 \
    --vote-option-tree-depth 2 \
    --msg-batch-depth 1 \
    --process-messages-zkey ./zkeys/ProcessMessages_10-2-1-2_test.0.zkey \
    --tally-votes-zkey ./zkeys/TallyVotes_10-1-2_test.0.zkey
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Setting verifying keys...
Transaction hash: 0x16236fe5e124f3d0c33ddf20a37ceba9730a659630258a1e858b3e335e057b8e
</code></pre>
<h3 id="coordinator-create-maci-instance-1"><a class="header" href="#coordinator-create-maci-instance-1">Coordinator: Create MACI instance</a></h3>
<pre><code class="language-bash">node build/index.js create \
    --vk-registry 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Deploying InitialVoiceCreditProxy
Deploying Poseidon contracts
Linking Poseidon libraries to MACI
Linking Poseidon libraries to PollFactory
Linking Poseidon libraries to MessageAqFactory
Deploying MACI
Transferring PollFactory ownership to MACI
Transferring MessageAqFactory ownership to PollFactory
Initialising MACI
MACI: 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a
</code></pre>
<h3 id="coordinator-deploy-poll-1"><a class="header" href="#coordinator-deploy-poll-1">Coordinator: Deploy poll</a></h3>
<pre><code class="language-bash">node ./build/index.js deployPoll \
    --maci-address 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --pubkey macipk.c974f4f168b79727ac98bfd53a65ea0b4e45dc2552fe73df9f8b51ebb0930330 \
    --duration 1000 \
    --max-messages 25 \
    --max-vote-options 25 \
    --int-state-tree-depth 1 \
    --msg-tree-depth 2 \
    --msg_batch_depth 1 \
    --vote-option-tree-depth 2
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Verifier: 0x0d8cc4b8d15D4c3eF1d70af0071376fb26B5669b
Poll ID: 0
Poll contract: 0x08e8f54262de52fe7Dfd0Bc0C9Ea87689d70e985
PollProcessorAndTallyer contract: 0xEcFcaB0A285d3380E488A39B4BB21e777f8A4EaC
</code></pre>
<h3 id="alice-sign-up"><a class="header" href="#alice-sign-up">Alice: sign up</a></h3>
<pre><code class="language-bash">node ./build/index.js signup \
    --pubkey macipk.3e7bb2d7f0a1b7e980f1b6f363d1e3b7a12b9ae354c2cd60a9cfa9fd12917391 \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Transaction hash: 0xcdff1e0cd3021cdc3ba2c65cfd74bac3715c32efdd2052c0e8f3a677a81a758b
State index: 1
</code></pre>
<h3 id="alice-votes-for-party-a-option-index-0"><a class="header" href="#alice-votes-for-party-a-option-index-0">Alice: votes for Party A (option index 0)</a></h3>
<pre><code class="language-bash">node build/index.js publish \
    --pubkey macipk.3e7bb2d7f0a1b7e980f1b6f363d1e3b7a12b9ae354c2cd60a9cfa9fd12917391 \
    --privkey macisk.fd7aa614ec4a82716ffc219c24fd7e7b52a2b63b5afb17e81c22fe21515539c \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --state-index 1 \
    --vote-option-index 0 \
    --new-vote-weight 9 \
    --nonce 1 \
    --poll-id 0
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Transaction hash: 0xc0964069834b171bb698ffc61e31e1be456c740ff1967ccad7d8cd8ed362e545
Ephemeral private key: macisk.1bf4bba7086c213606bb4a775b1ceaa4c2e7119c329748e675375f0d79c900dc
</code></pre>
<h3 id="alice-submits-an-invalid-vote-for-party-b-option-index-1-with-different-public-key"><a class="header" href="#alice-submits-an-invalid-vote-for-party-b-option-index-1-with-different-public-key">Alice: submits an invalid vote for Party B (option index 1) with different public key</a></h3>
<pre><code class="language-bash">node build/index.js publish \
    --pubkey macipk.d5788ea6ccf1ec295df99aaef859031fe7bd359e7e03acb80eb6e8a192f2ce19 \
    --privkey macisk.fd7aa614ec4a82716ffc219c24fd7e7b52a2b63b5afb17e81c22fe21515539c \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --state-index 1 \
    --vote-option-index 1 \
    --new-vote-weight 9 \
    --nonce 2 \
    --poll-id 0
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Transaction hash: 0xc13b97e23b387d8c160e0f8b1bfb33dc0ff4441fe63a37f0fc3ec84a0cfa0600
Ephemeral private key: macisk.5bc9f217a29c5defad1ca9be3d649add1eca30037589527476e8335b24cf75b
</code></pre>
<p>Time Travel</p>
<pre><code>node build timeTravel -s 1000
</code></pre>
<h3 id="coordinator-merge-state-tree-1"><a class="header" href="#coordinator-merge-state-tree-1">Coordinator: merge state tree</a></h3>
<pre><code class="language-bash">node build/index.js mergeSignups \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --poll-id 0
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Merging state subroots 1 / 1
Executed mergeMaciStateAqSubRoots(); gas used: 723525
Transaction hash: 0x14621b208fdadbf277edf80b393f1a9694099ae9676903e148fa485eecfadd4b

All state subtrees have been merged.
Merging subroots to a main state root...
Executed mergeStateAq(); gas used: 1015876
Transaction hash: 0xf2903b1c3c83b87c551a71f29e07762b464691ca58b0c6849b2f9b8f5783011f
The state tree has been merged.
</code></pre>
<h3 id="coordinator-merge-message-tree-1"><a class="header" href="#coordinator-merge-message-tree-1">Coordinator: merge message tree</a></h3>
<pre><code class="language-bash">node build/index.js mergeMessages \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --poll-id 0
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Merging message subroots 1 / 1
Executed mergeMaciStateAqSubRoots(); gas used: 604387
Transaction hash: 0xe0c0306b80febe1f6947b6ccbefabef38d01abce0b7611f49ce1cc7e20f196a5

All message subtrees have been merged.
Merging subroots to a main message root...
Executed mergeMessageAq(); gas used: 174376
Transaction hash: 0x424581f08d5f8e9f4fd63b083f9446cc2bff3b8e4b67ebc834076d6e9c34ec20
The message tree has been merged.
</code></pre>
<h3 id="coordinator-generate-proofs-1"><a class="header" href="#coordinator-generate-proofs-1">Coordinator: generate proofs</a></h3>
<pre><code class="language-bash">node build/index.js genProofs \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --privkey macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e \
    --poll-id 0 \
    --tally-file tally.json \
    --output proofs \
    --rapidsnark ~/rapidsnark/build/prover \
    --process-witnessgen ./zkeys/ProcessMessages_10-2-1-2_test \
    --tally-witnessgen ./zkeys/TallyVotes_10-1-2_test \
    --process-zkey ./zkeys/ProcessMessages_10-2-1-2_test.0.zkey \
    --tally-zkey ./zkeys/TallyVotes_10-1-2_test.0.zkey
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">fromBlock = 0
Generating proofs of message processing...

Progress: 1 / 1

Generating proofs of vote tallying...

Progress: 1 / 1

OK
</code></pre>
<h3 id="coordinator-prove-on-chain-1"><a class="header" href="#coordinator-prove-on-chain-1">Coordinator: prove on chain</a></h3>
<pre><code class="language-bash">node build/index.js proveOnChain \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --poll-id 0 \
    --ppt 0xEcFcaB0A285d3380E488A39B4BB21e777f8A4EaC \
    --proof-dir proofs/
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">Submitting proofs of message processing...
Transaction hash: 0x59388e69899612390ef22de235629e9355e14f888bb330b46511cc06d8f2035d
Progress: 1 / 1
All message processing proofs have been submitted.

Submitting proofs of vote tallying...
Progress: 1 / 1
Transaction hash: 0xc90e3bd0618def86b709c995485271f806c60701a3f4246903498f27346b9f5e
All vote tallying proofs have been submitted.

OK
</code></pre>
<h3 id="anyone-verify"><a class="header" href="#anyone-verify">Anyone: verify</a></h3>
<pre><code class="language-bash">node build/index.js verify \
    --contract 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    --poll-id 0 \
    --tally-file tally.json \
    --ppt 0xEcFcaB0A285d3380E488A39B4BB21e777f8A4EaC
</code></pre>
<p>Output:</p>
<pre><code class="language-bash">{
  provider: 'http://localhost:8545',
  maci: '0xf204a4Ef082f5c04bB89F7D5E6568B796096735a',
  pollId: 0,
  newTallyCommitment: '0x29b47e79c10709047ba9788580c2dc8528f003eab42d30670df78a47b121aa6c',
  results: {
    tally: [
      '9', '0', '0', '0', '0', '0',
      '0', '0', '0', '0', '0', '0',
      '0', '0', '0', '0', '0', '0',
      '0', '0', '0', '0', '0', '0',
      '0'
    ],
    salt: '0x132065c8ad3968008aeb7c114a04de228fa5b3618743ad00f64ad3f773a2e4d2'
  },
  totalSpentVoiceCredits: {
    spent: '81',
    salt: '0x2940f93e085350a04f6ff85e1ebffbc391fc3498f1cb41ab47f8899dc9c6efc6'
  },
  perVOSpentVoiceCredits: {
    tally: [
      '81', '0', '0', '0', '0', '0',
      '0',  '0', '0', '0', '0', '0',
      '0',  '0', '0', '0', '0', '0',
      '0',  '0', '0', '0', '0', '0',
      '0'
    ],
    salt: '0x2db5c3d6b015f8e2ea1cf7ffed7a44af0db8a8c09a5077415c076b6ebcee0571'
  }
}
OK
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="smart-contracts"><a class="header" href="#smart-contracts">Smart Contracts</a></h1>
<p>MACI is composed of multiple smart contracts, which together with the zk-SNARK circuits, can be used to carry out on-chain voting.</p>
<p>The main contracts are presented and explained below.</p>
<h2 id="macisol"><a class="header" href="#macisol">MACI.sol</a></h2>
<p><code>MACI.sol</code> is the core contract of the project, as it provides the base layer for user signups and Polls to be created.</p>
<p>The constructor shown below accepts three arguments, a <code>PollFactory</code> contract, a <code>SignUpGatekeeper</code> contract, and an <code>InitialVoiceCreditProxy</code> contract.</p>
<pre><code class="language-javascript">constructor(
    PollFactory _pollFactory,
    SignUpGatekeeper _signUpGatekeeper,
    InitialVoiceCreditProxy _initialVoiceCreditProxy
) {
    // Deploy the state AccQueue
    stateAq = new AccQueueQuinaryBlankSl(STATE_TREE_SUBDEPTH);
    stateAq.enqueue(BLANK_STATE_LEAF_HASH);

    pollFactory = _pollFactory;
    signUpGatekeeper = _signUpGatekeeper;
    initialVoiceCreditProxy = _initialVoiceCreditProxy;

    signUpTimestamp = block.timestamp;

    // Verify linked poseidon libraries
    require(
        hash2([uint256(1), uint256(1)]) != 0,
        &quot;MACI: poseidon hash libraries not linked&quot;
    );
}
</code></pre>
<p>Upon deployment, the contract will deploy a new <code>AccQueueQuinaryBlankSl</code> contract using the <code>STATE_TREE_SUBDEPTH</code>. By default, this is defined as <code>uint8 internal constant STATE_TREE_SUBDEPTH = 2;</code>.</p>
<p>Should this be changed, it will be necessary to amend the <code>contracts/ts/genEmptyBallotRootsContract.ts</code> file to reflect the change. The first action on this deployed contract, is to enqueue (add) an empty hash (defined as <code>6769006970205099520508948723718471724660867171122235270773600567925038008762</code>).</p>
<p>After this, the contracts will be stored to state, the current time taken and then the contract will perform a simple sanity check to ensure that the Poseidon hash libraries were linked successfully.</p>
<p>Once the contract is deployed, the owner (set as the deployer address of MACI), is required to call the <code>init</code> function, which is shown below:</p>
<pre><code class="language-javascript">function init(
    VkRegistry _vkRegistry,
    MessageAqFactory _messageAqFactory,
    TopupCredit _topupCredit
    ) public onlyOwner {
    require(!isInitialised, &quot;MACI: already initialised&quot;);

    isInitialised = true;

    vkRegistry = _vkRegistry;
    messageAqFactory = _messageAqFactory;
    topupCredit = _topupCredit;

    // Check that the factory contracts have correct access controls before
    // allowing any functions in MACI to run (via the afterInit modifier)
    require(
        pollFactory.owner() == address(this),
        &quot;MACI: PollFactory owner incorrectly set&quot;
    );

    // The PollFactory needs to store the MessageAqFactory address
    pollFactory.setMessageAqFactory(messageAqFactory);

    // The MessageAQFactory owner must be the PollFactory contract
    require(
        messageAqFactory.owner() == address(pollFactory),
        &quot;MACI: MessageAqFactory owner incorrectly set&quot;
    );

    // The VkRegistry owner must be the owner of this contract
    require(
        vkRegistry.owner() == owner(),
        &quot;MACI: VkRegistry owner incorrectly set&quot;
    );

    emit Init(_vkRegistry, _messageAqFactory);
}
</code></pre>
<p>This function accepts three arguments:</p>
<ul>
<li><code>VkRegistry</code> - the contract holding the verifying keys</li>
<li><code>MessageAqFactory</code> - the factory contract for deploying new MessageAq contracts</li>
<li><code>TopupCredit</code> - the contract responsible for topping up voting credits</li>
</ul>
<p>In more details, the <code>init</code> function will check/do the following:</p>
<ol>
<li>That the <code>PollFactory</code> contract's owner has been set to be the <code>MACI</code> contract</li>
<li>Set the <code>messageAqFactory</code> contract on the <code>pollFactory</code> contract</li>
<li>Check that the owner of the <code>messageAqFactory</code> is the <code>pollFactory</code> contract</li>
<li>Confirm that the <code>vkRegistry</code> owner is the same as the <code>MACI</code> owner</li>
</ol>
<p>Finally, it will emit an event.</p>
<p>Next, we have the <code>signUp</code> function, which allows users to <code>signUp</code> using a <code>SignUpGatekeeper</code> contract. This contract can use any mean necessary to gatekeep access to MACI's polls. For instance, only wallets with access to a specific ERC721 token can be allowed to sign up. Please note that this function can only be called after the contract is initialized (thanks to the <code>afterInit</code> modifier).</p>
<p>This function does the following:</p>
<ul>
<li>checks that the maxium number of signups have not been reached. As of now, this will be $5 ** 10 - 1$ due to circuit limitations.</li>
<li>checks that the provided public key is within the allowed boundaries</li>
<li>increases the number of signups</li>
<li>registers the user using the sign up gatekeeper contract. It is important that whichever gatekeeper is used, it reverts if an user tries to sign up twice.</li>
<li>calls the voice credit proxy to retrieve the number of allocated voice credits for the calling account</li>
<li>hashes the voice credits alongside the calling address and the current time</li>
<li>enqueues this hashed data into the <code>stateAq</code> contract</li>
</ul>
<pre><code class="language-javascript">function signUp(
    PubKey memory _pubKey,
    bytes memory _signUpGatekeeperData,
    bytes memory _initialVoiceCreditProxyData
) public afterInit {
    // The circuits only support up to (5 ** 10 - 1) signups
    require(
        numSignUps &lt; STATE_TREE_ARITY**stateTreeDepth,
        &quot;MACI: maximum number of signups reached&quot;
    );

    require(
        _pubKey.x &lt; SNARK_SCALAR_FIELD &amp;&amp; _pubKey.y &lt; SNARK_SCALAR_FIELD,
        &quot;MACI: _pubKey values should be less than the snark scalar field&quot;
    );

    // Increment the number of signups
    numSignUps++;

    // Register the user via the sign-up gatekeeper. This function should
    // throw if the user has already registered or if ineligible to do so.
    signUpGatekeeper.register(msg.sender, _signUpGatekeeperData);

    // Get the user's voice credit balance.
    uint256 voiceCreditBalance = initialVoiceCreditProxy.getVoiceCredits(
        msg.sender,
        _initialVoiceCreditProxyData
    );

    uint256 timestamp = block.timestamp;
    // Create a state leaf and enqueue it.
    uint256 stateLeaf = hashStateLeaf(
        StateLeaf(_pubKey, voiceCreditBalance, timestamp)
    );
    uint256 stateIndex = stateAq.enqueue(stateLeaf);

    emit SignUp(stateIndex, _pubKey, voiceCreditBalance, timestamp);
}
</code></pre>
<p>Once everything has been setup, polls can be deployed using the <code>deployPoll</code> function. This function is not protected by access control, therefore any user can deploy one. It should be noted however, that previous poll should have been closed out first, and this can only be done by the owner of the contract, which is the <code>MACI</code> contract itself.</p>
<pre><code class="language-javascript">function deployPoll(
    uint256 _duration,
    MaxValues memory _maxValues,
    TreeDepths memory _treeDepths,
    PubKey memory _coordinatorPubKey
) public afterInit {
    uint256 pollId = nextPollId;

    // Increment the poll ID for the next poll
    nextPollId++;

    if (pollId &gt; 0) {
        require(
            stateAq.treeMerged(),
            &quot;MACI: previous poll must be completed before using a new instance&quot;
        );
    }

    // The message batch size and the tally batch size
    BatchSizes memory batchSizes = BatchSizes(
        MESSAGE_TREE_ARITY**uint8(_treeDepths.messageTreeSubDepth),
        STATE_TREE_ARITY**uint8(_treeDepths.intStateTreeDepth),
        STATE_TREE_ARITY**uint8(_treeDepths.intStateTreeDepth)
    );

    Poll p = pollFactory.deploy(
        _duration,
        _maxValues,
        _treeDepths,
        batchSizes,
        _coordinatorPubKey,
        vkRegistry,
        this,
        topupCredit,
        owner()
    );

    polls[pollId] = p;

    emit DeployPoll(pollId, address(p), _coordinatorPubKey);
}
</code></pre>
<h2 id="pollsol"><a class="header" href="#pollsol">Poll.sol</a></h2>
<p>This contract allows users to vote on a Poll.</p>
<p>The main functions of the contract are as follows:</p>
<ul>
<li><code>topup</code> - This function accepts two parameters, a <code>stateIndex</code>, and an <code>amount</code>. It can only be called before the voting deadline.
After checking whether the deadline has passed or not, it will validate that the contract has not reached the maximum number of messages, if the checks passes, it will increase the number of messages by 1.
It will then try to transfer the amount of <code>topUpCredit</code> tokens.
Finally, it will create a new Message object that will be hashed and enqueued in the <code>messageAq</code> contract. This messageAq contract is reserved for this one poll only and will only contain its messages.</li>
<li><code>publishMessage</code> - This function allows anyone to publish a message, and it accepts the message object as well as an ephemeral public key. This key together with the coordinator public key will be used to generate a shared ECDH key that will encrypt the message.
Before saving the message, the function will check that the voting deadline has not passed, as well as the max number of messages was not reached.</li>
</ul>
<p>The <code>mergeMaciStateAqSubRoots</code> function can be called by the contract admin after the voting deadline and looks like the following:</p>
<pre><code class="language-javascript">function mergeMaciStateAqSubRoots(uint256 _numSrQueueOps, uint256 _pollId)
    public
    onlyOwner
    isAfterVotingDeadline
    {
        // This function can only be called once per Poll
        require(!stateAqMerged, ERROR_STATE_AQ_ALREADY_MERGED);

        if (!extContracts.maci.stateAq().subTreesMerged()) {
            extContracts.maci.mergeStateAqSubRoots(_numSrQueueOps, _pollId);
        }

        emit MergeMaciStateAqSubRoots(_numSrQueueOps);
    }
</code></pre>
<p>If the subtrees have not been merged on the MACI contract's <code>stateAq</code>, then it will merge it by calling <code>mergeStateAqSubroots</code>. It accets two parameters:</p>
<ul>
<li><code>_numSrQueueOps</code> - the number of operations required</li>
<li><code>_pollId</code> - the id of the poll</li>
</ul>
<p>The next function, is presented below:</p>
<pre><code class="language-javascript">function mergeMaciStateAq(uint256 _pollId)
        public
        onlyOwner
        isAfterVotingDeadline
    {
        // This function can only be called once per Poll after the voting
        // deadline
        require(!stateAqMerged, ERROR_STATE_AQ_ALREADY_MERGED);

        stateAqMerged = true;

        require(
            extContracts.maci.stateAq().subTreesMerged(),
            ERROR_STATE_AQ_SUBTREES_NEED_MERGE
        );

        mergedStateRoot = extContracts.maci.mergeStateAq(_pollId);

        // Set currentSbCommitment
        uint256[3] memory sb;
        sb[0] = mergedStateRoot;
        sb[1] = emptyBallotRoots[treeDepths.voteOptionTreeDepth - 1];
        sb[2] = uint256(0);

        currentSbCommitment = hash3(sb);
        emit MergeMaciStateAq(mergedStateRoot);
    }
</code></pre>
<p>This function only accepts one parameter, and can be called by the owner only, and after the voting deadline. The parameter is the pollId for which we want to perform the operation. This function can only be called once per poll, and it will check that the sub trees have been merged on MACI's AccQueue contract. Finally it will merge the whole AccQueue to generate the state root, and store the current commitment comprised of:</p>
<p>the Poseidon hash of the merkle root, an empty ballot root stored in the emptyBallotRoots mapping (shown below), and a zero.</p>
<pre><code class="language-javascript">emptyBallotRoots[0] =
  uint256(
    6579820437991406069687396372962263845395426835385368878767605633903648955255,
  );
emptyBallotRoots[1] =
  uint256(
    9105453741665960449792281626882014222103501499246287334255160659262747058842,
  );
emptyBallotRoots[2] =
  uint256(
    14830222164980158319423900821611648302565544940504586015002280367515043751869,
  );
emptyBallotRoots[3] =
  uint256(
    12031563002271722465187541954825013132282571927669361737331626664787916495335,
  );
emptyBallotRoots[4] =
  uint256(
    5204612805325639173251450278876337947880680931527922506745154187077640790699,
  );
</code></pre>
<p>In order for the <code>processMessages</code> circuit to access the message root, the following two functions need to be called (only by the owner):</p>
<ul>
<li><code>mergeMessageAqSubRoots</code> - merges the Poll's messages tree subroot</li>
<li><code>mergeMessageAq</code> - merges the Poll's messages tree</li>
</ul>
<h2 id="pollfactorysol"><a class="header" href="#pollfactorysol">PollFactory.sol</a></h2>
<p><code>PollFactory</code> is a smart contract that is used to deploy new Polls. This is used by MACI inside the <code>deployPoll</code> function. It only contains two functions:</p>
<ul>
<li><code>setMessageAqFactory</code> - owner only function which allows to set the address of the <code>MessageAqFactory</code> (a contract used to deploy new AccQueue contracts)</li>
<li><code>deploy</code> - owner only function which allows to deploy a new Poll</li>
</ul>
<p>The arguments required to deploy a new Poll are the following:</p>
<pre><code class="language-javascript">uint256 _duration,
MaxValues memory _maxValues,
TreeDepths memory _treeDepths,
BatchSizes memory _batchSizes,
PubKey memory _coordinatorPubKey,
VkRegistry _vkRegistry,
IMACI _maci,
TopupCredit _topupCredit,
address _pollOwner
</code></pre>
<p>Upon deployment, the ownership of the messageAq contract will be transferred to the deployed poll, as well as the ownership of the new Poll contract be transferred to the poll owner, which in MACI is set as the owner of MACI.</p>
<h2 id="pollprocessorandtallyer"><a class="header" href="#pollprocessorandtallyer">PollProcessorAndTallyer</a></h2>
<p>This contract is used to prepare parameters for the zk-SNARK circuits as well as for verifying proofs. It should be deployed alongside MACI and ownership assigned to the coordinator.</p>
<h2 id="messageaqfactory"><a class="header" href="#messageaqfactory">MessageAqFactory</a></h2>
<p>This is a simple factory contract which allows to deploy new <code>AccQueueQuinaryMaci</code> contracts. It exposes one function, <code>deploy</code>, which can only be called by the contract owner. After deployment of the contract, it will transfer its ownership to the same owner as the factory contract.</p>
<pre><code class="language-javascript">contract MessageAqFactory is Ownable {
    function deploy(uint256 _subDepth) public onlyOwner returns (AccQueue) {
        AccQueue aq = new AccQueueQuinaryMaci(_subDepth);
        aq.transferOwnership(owner());
        return aq;
    }
}
</code></pre>
<h2 id="signuptoken"><a class="header" href="#signuptoken">SignUpToken</a></h2>
<p>This contract should be used by the SignUpGateKeeper to determine whether a user is allowed to register. The default contract provided with MACI is a simple ERC721 token. Coordinators can use this contract to mint a token for each of the participants in the voting process.</p>
<h2 id="signupgatekeeper"><a class="header" href="#signupgatekeeper">SignUpGatekeeper</a></h2>
<p>MACI requires a signup gatekeeper to ensure that only designed users register. It is up to MACI's deployer how they wish to allow sign-ups, therefore they can implement their own GateKeeper. The repository comes with two presets:</p>
<ul>
<li><code>FreeForAllSignUpGatekeeper</code> - This allows anyone to signup on MACI.</li>
<li><code>SignUpTokenGatekeeper</code> - This makes use of a ERC721 token to gatekeep the signup function.</li>
</ul>
<p>An abstract contract to inherit from is also provided, with two function signatures as shown below:</p>
<pre><code class="language-javascript">abstract contract SignUpGatekeeper {
    function setMaciInstance(MACI _maci) public virtual {}
    function register(address _user, bytes memory _data) public virtual {}
}
</code></pre>
<p>The MACI contract will need to call <code>register</code> inside the <code>signUp</code> function.</p>
<h2 id="voicecreditproxy"><a class="header" href="#voicecreditproxy">VoiceCreditProxy</a></h2>
<p>The VoiceCreditProxy contract is used to assign voice credits to users. Whichever implementation should the MACI deployers use, this must implement a view function that returns the balance for a user, such as the one below:</p>
<pre><code class="language-javascript">function getVoiceCredits(address _user, bytes memory _data) public virtual view returns (uint256) {}
</code></pre>
<h2 id="hasher"><a class="header" href="#hasher">Hasher</a></h2>
<p>This contract exposes methods to hash different number of parameters with the Poseidon hash.</p>
<h2 id="vkregistry"><a class="header" href="#vkregistry">VkRegistry</a></h2>
<p>The VkRegistry is a contract that holds the verifying keys for the zk-SNARK circuits. It holds three different sets of keys:</p>
<ul>
<li><code>processVks</code> - The keys for the processMessages circuit</li>
<li><code>tallyVks</code> - The keys for the tallyVotes circuit</li>
<li><code>subsidyVk</code> - The keys for the subsidy circuit</li>
</ul>
<p>Each circuit will have a signature which is its compile-time constants represented as a uint256.</p>
<h2 id="params"><a class="header" href="#params">Params</a></h2>
<p>A contract holding three structs:</p>
<pre><code class="language-go">struct TreeDepths {
    uint8 intStateTreeDepth;
    uint8 messageTreeSubDepth;
    uint8 messageTreeDepth;
    uint8 voteOptionTreeDepth;
}

struct BatchSizes {
    uint24 messageBatchSize;
    uint24 tallyBatchSize;
    uint24 subsidyBatchSize;
}

struct MaxValues {
    uint256 maxMessages;
    uint256 maxVoteOptions;
}
</code></pre>
<p>These are stored separately to avoid a stack overlow error during compilation of the contracts using them.</p>
<h2 id="accqueue"><a class="header" href="#accqueue">AccQueue</a></h2>
<p>The AccQueue contract represents a Merkle Tree where each leaf insertion only updates a subtree. To obtain the main tree root, the subtrees must be merged together by the contract owner. This requires at least two operations, a <code>mergeSubRoots</code> and a <code>merge</code>.</p>
<p>The contract can be initialized to work as a traditional Merkle Tree (2 leaves per node) or a Quinary Tree (5 leaves per node). This can be achieved by passing either two or five as parameter to the constructor (<code>_hashLength</code>). Any other values should not be accepted.</p>
<p>Below are presented the most important functions of the smart contract:</p>
<ul>
<li><code>enqueue</code> - Allows to add a leaf to the queue for the current subtree. Only one parameter is accepted and that is the leaf to insert.</li>
<li><code>insertSubTree</code> - Admin only function which allows to insert a full subtree (batch enqueue)</li>
<li><code>mergeSubRoots</code> - Allows the contract owner to merge all of the subtrees to form the shortest possible tree. The argument <code>_numSrQueueOps</code> can be used to perform the operation in multiple transactions (as this might trigger the block gas limit).</li>
<li><code>merge</code> - Allows the contract admin to form a main tree with the desired depth. The depth must fit all of the leaves.</li>
</ul>
<h2 id="emptyballotroots"><a class="header" href="#emptyballotroots">EmptyBallotRoots</a></h2>
<p>This contract contains the roots of Ballot trees of five leaf configurations.</p>
<pre><code class="language-javascript">emptyBallotRoots[0] =
  uint256(
    6579820437991406069687396372962263845395426835385368878767605633903648955255,
  );
emptyBallotRoots[1] =
  uint256(
    9105453741665960449792281626882014222103501499246287334255160659262747058842,
  );
emptyBallotRoots[2] =
  uint256(
    14830222164980158319423900821611648302565544940504586015002280367515043751869,
  );
emptyBallotRoots[3] =
  uint256(
    12031563002271722465187541954825013132282571927669361737331626664787916495335,
  );
emptyBallotRoots[4] =
  uint256(
    5204612805325639173251450278876337947880680931527922506745154187077640790699,
  );
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="circuits"><a class="header" href="#circuits">Circuits</a></h1>
<p>MACI has three zk-SNARK circuits:</p>
<ol>
<li><code>ProcessMessages.circom</code>, which takes a batch of messages, and updates the
state and ballot trees according to the contents of said messages.</li>
<li><code>TallyVotes.circom</code>, which counts votes from users' ballots, batch by batch.</li>
<li><code>Subsidy.circom</code>, which implements <a href="https://hackmd.io/@chaosma/H1_9xmT2K">pairwise subsidy</a></li>
</ol>
<p>Each circuit is parameterised and it is important to set the right parameters
to your use case. For example, if you want to support up to 3125 messages, the message tree depth parameter should be set to <code>5</code> (as $5^5 = 3125$).</p>
<p>Next, navigate to the <code>cli/</code> directory and edit <code>zkeys.config.yml</code>.</p>
<p>This config file defines the parameters required for MACI's circuits.</p>
<h3 id="message-processing"><a class="header" href="#message-processing">Message processing</a></h3>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>State tree depth</td><td>Should be set to 10. Allows 9,765,625 signups.</td></tr>
<tr><td>1</td><td>Message tree depth</td><td>Allows $(5^{n})$ votes or key-change messages.</td></tr>
<tr><td>2</td><td>Message batch tree depth</td><td>Allows $(5^{n})$ messages to be processed per batch.</td></tr>
<tr><td>3</td><td>Vote option tree depth</td><td>Allows $(5^{n})$ vote options.</td></tr>
</tbody></table>
<h3 id="vote-tallying"><a class="header" href="#vote-tallying">Vote tallying</a></h3>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>State tree depth</td><td>Should be set to 10. Allows 9,765,625 signups.</td></tr>
<tr><td>1</td><td>State leaf batch depth</td><td>Allows $(5^{n})$ users' votes to be processed per batch.</td></tr>
<tr><td>2</td><td>Vote option tree depth</td><td>Allows $(5^{n})$ vote options.</td></tr>
</tbody></table>
<h3 id="subsisdy"><a class="header" href="#subsisdy">Subsisdy</a></h3>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>State tree depth</td><td>Should be set to 10. Allows 9,765,625 signups.</td></tr>
<tr><td>1</td><td>State leaf batch depth</td><td>Allows $(5^{n})$ users' votes to be processed per batch.</td></tr>
<tr><td>2</td><td>Vote option tree depth</td><td>Allows $(5^{n})$ vote options.</td></tr>
</tbody></table>
<h2 id="compile-circuits"><a class="header" href="#compile-circuits">Compile circuits</a></h2>
<p>Run:</p>
<pre><code class="language-bash">npx zkey-manager compile -c ./zkeys.config.yml
</code></pre>
<p>The larger the trees, the more time this process may take. You may also need a
machine with a very large amount of memory.</p>
<h2 id="measure-the-circuit-sizes"><a class="header" href="#measure-the-circuit-sizes">Measure the circuit sizes</a></h2>
<p>The size of a circuit is denoted by its number of constraints. The larger this
number, the more time it takes to compile it, generate its <code>.zkey</code> file, and
perform phase 2 contributions.</p>
<p>Run this command to measure a circuit:</p>
<pre><code class="language-bash">npx snarkjs r1cs info CIRCUIT_NAME.circom
</code></pre>
<h2 id="download-the-ptau-file"><a class="header" href="#download-the-ptau-file">Download the <code>.ptau</code> file</a></h2>
<p>This file should be the result of the Perpetual Powers of Tau trusted setup
contribution which <a href="https://blog.hermez.io/hermez-cryptographic-setup/">Hermez Network
selected</a>.</p>
<p>Run:</p>
<pre><code class="language-bash">npx zkey-manager downloadPtau -c ./zkeys.config.yml
</code></pre>
<p><code>zkey-manager</code> will select the smallest <code>.ptau</code> file that fits the largest
circuit specified in <code>zkeys.config.yml</code>.</p>
<h2 id="generate-zkey-files-1"><a class="header" href="#generate-zkey-files-1">Generate <code>.zkey</code> files</a></h2>
<p>Run:</p>
<pre><code class="language-bash">npx zkey-manager genZkeys -c ./zkeys.config.yml
</code></pre>
<p>This generates the initial <code>.zkey</code> files for each circuit.</p>
<p>You should perform at least one contribution to each circuit, even if you
choose not to perform a multi-party trusted setup.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trusted-setup"><a class="header" href="#trusted-setup">Trusted setup</a></h1>
<p>MACI currently uses Groth16 zk-SNARKs written in <code>circom</code>. Teams who wish to
build on MACI may choose to perform a multi-party trusted setup. This allows
observers to have a higher degree of confidence that the coordinator cannot
generate fake proofs. Some teams, however, may forgo the trusted setup.</p>
<p>There are two possible reasons for doing so: if a team does not intend
to manage a large amount of value, and if their users accept that the risk of
coordinator misbehaviour is insufficient to justify doing the work nof a
trusted setup. After all, MACI's security model presumes a trusted coordinator.</p>
<p>In any case, MACI can be relatively easily modified to support PLONK, which
does not require a circuit-specific trusted setup. Its circuits, written in
<a href="https://github.com/iden3/circom"><code>circom</code></a>, are compatible with Fluidex's
<a href="https://github.com/Fluidex/plonkit"><code>plonkit</code></a> tool. The downside to using
PLONK is that proof generation is not as optimised as it is for Groth16.</p>
<h2 id="how-to-run-the-trusted-setup"><a class="header" href="#how-to-run-the-trusted-setup">How to run the trusted setup</a></h2>
<p>First, follow the instructions in the <a href="./installation.html">Installation</a>
section to install dependencies for MACI.</p>
<p>Next, configure and compile circuits following instructions in
<a href="./circuits.html">Circuits</a>.</p>
<p>Finally, use the <a href="https://github.com/privacy-scaling-explorations/multisetups"><code>multisetups</code></a>
tool to do this.</p>
<p>You should perform at least one contribution to each circuit, even if you
choose not to perform a multi-party trusted setup.</p>
<p>We don't recommend a browser-based trusted setup (which <a href="https://ceremony.tornado.cash/">Tornado
Cash</a> and <a href="https://mpc.zkopru.network/">Zkopru</a>
used) for the MACI circuits as they are too large to be feasibly processed in
the browser.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<h2 id="contracts"><a class="header" href="#contracts">Contracts</a></h2>
<p>First, compile the contracts.</p>
<p>From the main <code>maci/</code> directory, run:</p>
<pre><code class="language-bash">cd contracts &amp;&amp; \
npm run compileSol
</code></pre>
<p>To run Contracts only tests, run:</p>
<pre><code class="language-bash">cd contracts &amp;&amp; \
npm run test
</code></pre>
<p>To test the system as a whole, run Hardhat Network (a local Ethereum testnet) in a separate terminal:</p>
<pre><code class="language-bash">cd contracts &amp;&amp; \
npm run test
</code></pre>
<h2 id="cli"><a class="header" href="#cli">CLI</a></h2>
<p>You can test the CLI locally. First, you need to either generate <code>.zkey</code> files,
or download them. Do not use these testing <code>.zkey</code> files in production.</p>
<h3 id="download-zkey-files-or-the-witness-generation-binaries"><a class="header" href="#download-zkey-files-or-the-witness-generation-binaries">Download <code>.zkey</code> files or the witness generation binaries</a></h3>
<p>MACI has three zk-SNARK circuits. Each circuit is parameterised. There should one
<code>.zkey</code> file for each circuit and set of parameters.</p>
<p>Unless you wish to generate a fresh set of <code>.zkey</code> files, you should obtain
them from someone who has performed a multi-party trusted setup for said
circuits.</p>
<p>Note the locations of the <code>.zkey</code> files as the CLI requires them as
command-line flags.</p>
<p>You cand download a <code>.zkey</code> files and associated <code>.r1cs</code> file with witness generation binaries from <a href="https://github.com/privacy-scaling-explorations/maci/wiki/Download-Precompiled-Circuit-and-Zkeys">here</a>.</p>
<h3 id="compile-the-witness-generation-binaries"><a class="header" href="#compile-the-witness-generation-binaries">Compile the witness generation binaries</a></h3>
<p>From the main <code>maci/cli</code> directory, run:</p>
<pre><code>npx zkey-manager compile -c ./zkeys.config.yml
</code></pre>
<p>You should see the following files in <code>maci/cli/zkeys/</code>:</p>
<pre><code>ProcessMessages_10-2-1-2_test
ProcessMessages_10-2-1-2_test.circom
ProcessMessages_10-2-1-2_test.dat
ProcessMessages_10-2-1-2_test.r1cs
ProcessMessages_10-2-1-2_test.sym
ProcessMessages_10-2-1-2_test_cpp
ProcessMessages_10-2-1-2_test_js
SubsidyPerBatch_10-1-2_test
SubsidyPerBatch_10-1-2_test.circom
SubsidyPerBatch_10-1-2_test.dat
SubsidyPerBatch_10-1-2_test.r1cs
SubsidyPerBatch_10-1-2_test.sym
SubsidyPerBatch_10-1-2_test_cpp
SubsidyPerBatch_10-1-2_test_js
TallyVotes_10-1-2_test
TallyVotes_10-1-2_test.circom
TallyVotes_10-1-2_test.dat
TallyVotes_10-1-2_test.r1cs
TallyVotes_10-1-2_test.sym
TallyVotes_10-1-2_test_cpp
TallyVotes_10-1-2_test_js
</code></pre>
<h3 id="check-the-rapidsnark-binary"><a class="header" href="#check-the-rapidsnark-binary">Check the Rapidsnark binary</a></h3>
<p>Next, ensure that the <code>prover</code> binary of <code>rapidsnark</code> is in
<code>~/rapidsnark/build/prover</code>.</p>
<h3 id="run-cli-tests"><a class="header" href="#run-cli-tests">Run CLI tests</a></h3>
<p>You can find the tests in <code>maci/cli/tests</code>.</p>
<p>e.g. In <code>maci/cli/tests/vanilla</code>:</p>
<pre><code class="language-bash">./test1.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integrating-maci"><a class="header" href="#integrating-maci">Integrating MACI</a></h1>
<p>MACI can be used in any protocol that requires collusion resistance, for instance it has been proven to be quite efficient when integrated in quadratic funding applications such as <a href="https://github.com/clrfund/monorepo">clr.fund</a> and <a href="https://github.com/quadratic-funding/qfi/tree/feat/code-freeze">qfi</a>.</p>
<p>Here we will be looking at QFI and how it was used. Please note that this will be expanded as QFI is updated to use the newest version of MACI. Should you decide to integrate MACI in the meantime, feel free to open an issue on the GitHub repo.</p>
<h2 id="maci-contract"><a class="header" href="#maci-contract">MACI Contract</a></h2>
<p>The MACI contract is the core of the protocol. Contracts can inherit from MACI and thus expose the signup and topup functions. As with standalone MACI, one would need to deploy a sign up gatekeeper as well as the voice credit proxy.</p>
<p>As an example, within the quadratic funding infrastructure project, the QFI contract inherits from MACI and allows sign up via the contribute function.</p>
<pre><code class="language-javascript">function contribute(
    PubKey calldata pubKey,
    uint256 amount
    ) external {

    [..snip]

    uint256 voiceCredits = amount / voiceCreditFactor;
    // The user is marked as registered here upon contribution
    grantRoundToContributors[nextGrantRoundId][msg.sender] = ContributorStatus(voiceCredits, true);

    // Increase the number of contributors for this round
    grantRoundToContributorsCount[nextGrantRoundId]++;

    bytes memory signUpGatekeeperAndInitialVoiceCreditProxyData = abi.encode(
        msg.sender,
        voiceCredits
    );

    signUp(
        pubKey,
        signUpGatekeeperAndInitialVoiceCreditProxyData,
        signUpGatekeeperAndInitialVoiceCreditProxyData
    );

    [..snip]

    emit ContributionSent(msg.sender, amount);
}
</code></pre>
<h2 id="poll-contract"><a class="header" href="#poll-contract">Poll Contract</a></h2>
<p>On the other hand, the Poll contract can be inherited to expose functionality such as top ups and publishing of messages/commands.</p>
<p>For instance, within QFI, the <code>publishMessageBatch</code> function call the <code>publishMessage</code> function of Poll, as shown below:</p>
<pre><code class="language-javascript">function publishMessageBatch(
    Message[] calldata _messages,
    PubKey[] calldata _encPubKeys
) external {
    // Check that the two arrays have the same length
    require(
        _messages.length == _encPubKeys.length,
        &quot;GrantRound: _messages and _encPubKeys should be the same length&quot;
    );

    uint256 batchSize = _messages.length;
    for (uint8 i = 0; i &lt; batchSize; ++i) {
        publishMessage(_messages[i], _encPubKeys[i]);
    }

    emit Voted(msg.sender);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="security-audit-2022"><a class="header" href="#security-audit-2022">Security Audit 2022</a></h1>
<p>In the summer of 2022, MACI v1 was audited by HashCloak. The audit covered both the zk-SNARK circuits and the Solidity smart contracts.</p>
<p>This audited revealed a number of high severity issues which have been remediated by the MACI development team. We will be looking at those in details in the following sections.</p>
<h2 id="data-is-not-fully-verified-during-a-state-update"><a class="header" href="#data-is-not-fully-verified-during-a-state-update">Data is not fully verified during a state update</a></h2>
<p>This issue could have allowed a malicious coordinator to change the MACI state arbitrarly, for instance by tampering with the voice credits and the voting public key of any user.</p>
<p>In more details, the <code>processMessages.circom</code> circuit, did not fully verify that after a state update, the new state was the result of executing an arbitrary number of user messages on the previous state. <code>topupStateLeaves</code> and <code>topupStateLeavesPathElements</code> were never verified against the current state, and <code>topupStateIndexes</code> and <code>topupAmounts</code> were not verified against the message root.</p>
<p>This was rectified with commit <a href="https://github.com/privacy-scaling-explorations/maci/pull/522/commits/6df6a4054da926b07f35c5befab4f1f8af33dcc6">6df6a4054da926b07f35c5befab4f1f8af33dcc6</a></p>
<h2 id="token-for-top-up-is-a-free-resource"><a class="header" href="#token-for-top-up-is-a-free-resource">Token for top-up is a free resource</a></h2>
<p>The provided <code>TopupCredit.sol</code> contract implemented unprotected <code>airdrop</code> and <code>airdropTo</code> functions, which could have allowed anyone to receive unlimited voice credits. While this contract was provided as a template, the issue has been rectified by adding the <code>onlyOwner</code> modifier to these two functions.</p>
<pre><code class="language-javascript">function airdropTo(address account, uint256 amount) public onlyOwner {
    require(amount &lt; MAXIMUM_AIRDROP_AMOUNT);
    _mint(account, amount);
}

function airdrop(uint256 amount) public onlyOwner {
    require(amount &lt; MAXIMUM_AIRDROP_AMOUNT, &quot;amount exceed maximum limit&quot;);
    _mint(msg.sender, amount);
}
</code></pre>
<h2 id="integer-overflow-problem-and-improper-bit-length-restriction"><a class="header" href="#integer-overflow-problem-and-improper-bit-length-restriction">Integer overflow problem and improper bit length restriction</a></h2>
<p>This issue within the <code>float.circom</code> circuit could have resulted in a overflow on the <code>IntegerDivision</code> template. This stemmed from the lack of validation of input size, as well as not preventing a division by zero. Furthemore, it was pointed out that using assert in circuits did not contribute to constraints verification, and could have been bypassed by a malicious coordinator.</p>
<p>The issue was rectified with commit <a href="https://github.com/privacy-scaling-explorations/maci/pull/523/commits/efd4617724e956d2566062c6fe882e1d45cba7c4">efd4617724e956d2566062c6fe882e1d45cba7c4</a></p>
<h2 id="messagequeue-in-pollfactory-is-uninitialized"><a class="header" href="#messagequeue-in-pollfactory-is-uninitialized">MessageQueue in PollFactory is uninitialized</a></h2>
<p>MACI uses a message queue (a quinary merkle tree) to store all the messages to be processed for a single poll. When deploying a new poll, a corresponding message queue contract is deployed as well, however this was never initialized with a zero value.</p>
<p>Should the queue never be initialized with the zero value, a malicious user could submit a message to initialize the queue with a value they know how to decrypt, which however would take a very long time to generate a proof for. This could result in a denial of service attack against the coordinator.</p>
<p>The code was fixed by enqueing a message containing the zero value <code>NOTHING_UP_MY_SLEEVE</code> which is the result of:</p>
<p><code>keccak256(&quot;Maci&quot;) % p</code></p>
<p>Transalted into code, an <code>init</code> function was included in the Poll contract, with the following enqueing of the placeholder leaf:</p>
<pre><code class="language-javascript">// init messageAq here by inserting placeholderLeaf
uint256[2] memory dat;
dat[0] = NOTHING_UP_MY_SLEEVE;
dat[1] = 0;
(Message memory _message, PubKey memory _padKey, uint256 placeholderLeaf) = padAndHashMessage(dat, 1);
extContracts.messageAq.enqueue(placeholderLeaf);
</code></pre>
<h2 id="additional-issues-and-improvements"><a class="header" href="#additional-issues-and-improvements">Additional issues and improvements</a></h2>
<p>The rest of the issues were either low risk, informational or general optimizations.</p>
<p>As an example, there were certain functions which did not enforce the checks-effets-interaction pattern, which could potentially have led to reentrancy attacks. While most of these have been fully remediated, the <code>deployPoll</code> function within MACI is not currently enfocing the pattern when deploying a new poll contract using the <code>PollFactory</code> factory contract.</p>
<pre><code class="language-javascript">function deployPoll(
    uint256 _duration,
    MaxValues memory _maxValues,
    TreeDepths memory _treeDepths,
    PubKey memory _coordinatorPubKey
) public afterInit {
    uint256 pollId = nextPollId;

   [..snip]

    Poll p = pollFactory.deploy(
        _duration,
        _maxValues,
        _treeDepths,
        batchSizes,
        _coordinatorPubKey,
        vkRegistry,
        this,
        topupCredit,
        owner()
    );

    polls[pollId] = p;

    emit DeployPoll(pollId, address(p), _coordinatorPubKey);
}
</code></pre>
<p>As seen above, an external call is made, before updating the state with the new poll. The issue is tracked <a href="https://github.com/privacy-scaling-explorations/maci/pull/522#discussion_r981863147">here</a> and only left open as the code does not enforce best practices, however it does not pose any immediate risk.</p>
<p>The rest of the issues were succesffuly fixed and reflected in the v1.1.1. For the full report, please refer to the <code>audit</code> folder inside the root of the repository.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
    </body>
</html>
